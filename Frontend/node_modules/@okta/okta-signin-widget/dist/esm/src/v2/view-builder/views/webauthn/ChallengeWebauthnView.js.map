{"version":3,"file":"ChallengeWebauthnView.js","sources":["../../../../../../../src/v2/view-builder/views/webauthn/ChallengeWebauthnView.js"],"sourcesContent":["import { _, loc, createButton, createCallout } from 'okta';\nimport { BaseForm } from '../../internals';\nimport BaseAuthenticatorView from '../../components/BaseAuthenticatorView';\nimport CryptoUtil from '../../../../util/CryptoUtil';\nimport webauthn from '../../../../util/webauthn';\nimport BrowserFeatures from '../../../../util/BrowserFeatures';\nimport ChallengeWebauthnInfoView from './ChallengeWebauthnInfoView';\nimport { getMessageFromBrowserError } from '../../../ion/i18nTransformer';\nimport ChallengeWebauthnFooter from '../../components/ChallengeWebauthnFooter';\n\nconst Body = BaseForm.extend({\n\n  title() {\n    return loc('oie.verify.webauth.title', 'login');\n  },\n\n  className: 'oie-verify-webauthn',\n\n  getUISchema() {\n    const schema = [];\n    // Returning custom array so no input fields are displayed for webauthn\n    if (webauthn.isNewApiAvailable()) {\n      const retryButton = createButton({\n        className: 'retry-webauthn button-primary default-custom-button',\n        title: loc('mfa.challenge.verify', 'login'),\n        click: () => {\n          this.getCredentialsAndSave();\n        }\n      });\n\n      schema.push({\n        View: ChallengeWebauthnInfoView,\n      }, {\n        View: retryButton,\n      });\n    } else {\n      schema.push({\n        View: createCallout({\n          className: 'webauthn-not-supported',\n          type: 'error',\n          subtitle: loc('oie.webauthn.error.not.supported', 'login'),\n        }),\n      });\n    }\n    return schema;\n  },\n\n  remove() {\n    BaseForm.prototype.remove.apply(this, arguments);\n    if (this.webauthnAbortController) {\n      this.webauthnAbortController.abort();\n      this.webauthnAbortController = null;\n    }\n  },\n\n  noButtonBar: true,\n\n  modelEvents: {\n    'error': '_stopVerification'\n  },\n\n  getCredentialsAndSave() {\n    this.clearErrors();\n    this._startVerification();\n    // AbortController is not supported in IE11\n    // eslint-disable-next-line compat/compat\n    this.webauthnAbortController = new AbortController();\n    const relatesToObject = this.options.currentViewState.relatesTo;\n    const authenticatorData = relatesToObject?.value || {};\n    const allowCredentials = [];\n    const authenticatorEnrollments = this.options.appState.get('authenticatorEnrollments').value || [];\n    authenticatorEnrollments.forEach((enrollement) => {\n      if (enrollement.key === 'webauthn') {\n        allowCredentials.push({\n          type: 'public-key',\n          id: CryptoUtil.strToBin(enrollement.credentialId),\n        });\n      }\n    });\n    const challengeData = authenticatorData.contextualData.challengeData;\n    const options = _.extend({}, challengeData, {\n      allowCredentials,\n      challenge: CryptoUtil.strToBin(challengeData.challenge),\n    });\n    // navigator.credentials() is not supported in IE11\n    // eslint-disable-next-line compat/compat\n    navigator.credentials.get({\n      publicKey: options,\n      signal: this.webauthnAbortController.signal\n    }).then((assertion) => {\n      this.model.set({\n        credentials : {\n          clientData: CryptoUtil.binToStr(assertion.response.clientDataJSON),\n          authenticatorData: CryptoUtil.binToStr(assertion.response.authenticatorData),\n          signatureData: CryptoUtil.binToStr(assertion.response.signature),\n        }\n      });\n      this.saveForm(this.model);\n    }, (error) => {\n      // Do not display if it is abort error triggered by code when switching.\n      // this.webauthnAbortController would be null if abort was triggered by code.\n      if (this.webauthnAbortController) {\n        this.model.trigger('error', this.model, {responseJSON: {errorSummary: getMessageFromBrowserError(error)}});\n      }\n    }).finally(() => {\n      // unset webauthnAbortController on successful authentication or error\n      this.webauthnAbortController = null;\n    });\n  },\n\n  _startVerification: function() {\n    this.$('.okta-waiting-spinner').show();\n    this.$('.retry-webauthn').hide();\n    this.$('.retry-webauthn')[0].textContent = loc('retry', 'login');\n  },\n\n  _stopVerification: function() {\n    this.$('.okta-waiting-spinner').hide();\n    this.$('.retry-webauthn').show();\n  }\n});\n\nexport default BaseAuthenticatorView.extend({\n  Body,\n  Footer: ChallengeWebauthnFooter,\n  postRender() {\n    BaseAuthenticatorView.prototype.postRender.apply(this, arguments);\n    // Trigger browser prompt automatically for other browsers for better UX.\n    if (webauthn.isNewApiAvailable() && !BrowserFeatures.isSafari()) {\n      this.form.getCredentialsAndSave();\n    }\n  },\n});\n"],"names":["Body","BaseForm","extend","title","loc","className","getUISchema","schema","webauthn","isNewApiAvailable","retryButton","createButton","click","getCredentialsAndSave","push","View","ChallengeWebauthnInfoView","createCallout","type","subtitle","remove","prototype","apply","arguments","webauthnAbortController","abort","noButtonBar","modelEvents","clearErrors","_startVerification","AbortController","relatesToObject","options","currentViewState","relatesTo","authenticatorData","value","allowCredentials","authenticatorEnrollments","appState","get","forEach","enrollement","key","id","CryptoUtil","strToBin","credentialId","challengeData","contextualData","_","challenge","navigator","credentials","publicKey","signal","then","assertion","model","set","clientData","binToStr","response","clientDataJSON","signatureData","signature","saveForm","error","trigger","responseJSON","errorSummary","getMessageFromBrowserError","finally","$","show","hide","textContent","_stopVerification","BaseAuthenticatorView","Footer","ChallengeWebauthnFooter","postRender","BrowserFeatures","isSafari","form"],"mappings":"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"}