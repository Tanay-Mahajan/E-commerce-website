{"version":3,"file":"OktaSignIn.js","sources":["../../../../src/widget/OktaSignIn.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\nimport Errors from 'util/Errors';\nimport Util from 'util/Util';\nimport Logger from 'util/Logger';\nimport getAuthClient from 'widget/getAuthClient';\nimport buildRenderOptions from 'widget/buildRenderOptions';\nimport createRouter from 'widget/createRouter';\nimport V1Router from 'v1/LoginRouter';\nimport V2Router from 'v2/WidgetRouter';\nimport Hooks from 'models/Hooks';\nimport {\n  WidgetOptions,\n  OktaSignInAPI,\n  RenderSuccessCallback,\n  RenderErrorCallback,\n  RenderResult,\n  RenderOptions,\n  HookFunction,\n  RenderResultSuccess,\n  EventCallback,\n  EventCallbackWithError,\n  EventName\n} from '../types';\nimport { OktaAuth, Tokens } from '@okta/okta-auth-js';\n\ndeclare type AbstractRouter = typeof V1Router | typeof V2Router;\n\nconst EVENTS_LIST = ['ready', 'afterError', 'afterRender'];\n\nexport default class OktaSignIn implements OktaSignInAPI {\n  Router: AbstractRouter;\n  options: WidgetOptions;\n  hooks: Hooks;\n  router: AbstractRouter;\n  authClient: OktaAuth;\n\n  constructor(options: WidgetOptions) {\n    Util.debugMessage(`\n        The Okta Sign-In Widget is running in development mode.\n        When you are ready to publish your app, embed the minified version to turn on production mode.\n        See: https://developer.okta.com/code/javascript/okta_sign-in_widget#cdn\n      `);\n\n    this.options = options;\n    this.authClient = getAuthClient(options);\n\n    // validate authClient configuration against widget options\n    if (options.useInteractionCodeFlow  && this.authClient.isPKCE() === false) {\n      throw new Errors.ConfigError(\n        'The \"useInteractionCodeFlow\" option requires PKCE to be enabled on the authClient.'\n      );\n    }\n\n    // Hooks can be modified before or after render\n    this.hooks = new Hooks({\n      hooks: options.hooks\n    });\n\n    let Router: AbstractRouter;\n    if ((options.stateToken && !Util.isV1StateToken(options.stateToken)) \n        // Self hosted widget can use `useInteractionCodeFlow` to use V2Router\n        || options.useInteractionCodeFlow \n        || options.proxyIdxResponse) {\n      Router = V2Router;\n    } else {\n      Router = V1Router;\n    }\n    this.Router = Router;\n\n    // Triggers the event up the chain so it is available to the consumers of the widget.\n    this.Router.prototype.Events.listenTo.call(this, Router.prototype, 'all', this.trigger);\n\n    // On the first afterRender event (usually when the Widget is ready) - emit a 'ready' event\n    this.once('afterRender', function(context) {\n      this.trigger('ready', context);\n    });\n  }\n\n  /**\n   * Render the sign in widget to an element. Returns a promise that will resolve on success or reject on error.\n   * @param options - options for the signin widget.\n   *        Must have an el or $el property to render the widget to.\n   * @param success - success callback function\n   * @param error - error callback function\n   */\n  renderEl(renderOptions: RenderOptions, successFn?: RenderSuccessCallback, errorFn?: RenderErrorCallback): Promise<RenderResult> {\n    if (this.router) {\n      throw new Error('An instance of the widget has already been rendered. Call remove() first.');\n    }\n\n    const res = createRouter(this.Router, this.options, renderOptions, this.authClient, successFn, errorFn, this.hooks);\n    this.router = res.router;\n    return res.promise;\n  }\n\n  \n  hide(): void {\n    if (this.router) {\n      this.router.hide();\n    }\n  }\n\n  show(): void {\n    if (this.router) {\n      this.router.show();\n    }\n  }\n\n  remove(): void {\n    if (this.router) {\n      this.router.remove();\n      this.router = undefined;\n    }\n  }\n\n  /**\n   * Renders the Widget and returns a promise that resolves to OAuth tokens\n   * @param options - options for the signin widget\n   */\n  showSignInToGetTokens(options?: RenderOptions): Promise<Tokens> {\n    const renderOptions = Object.assign(buildRenderOptions(this.options, options), {\n      redirect: 'never'\n    });\n    const promise = this.renderEl(renderOptions).then(res => {\n      return (res as RenderResultSuccess).tokens;\n    });\n    const authClient = this.router.settings.getAuthClient();\n    if (authClient.isAuthorizationCodeFlow() && !authClient.isPKCE()) {\n      throw new Errors.ConfigError('\"showSignInToGetTokens()\" should not be used for authorization_code flow. ' + \n        'Use \"showSignInAndRedirect()\" instead');\n    }\n    return promise;\n  }\n\n  /**\n   * Renders the widget and redirects to the OAuth callback\n   * @param options - options for the signin widget\n   */\n  showSignInAndRedirect(options?: RenderOptions): Promise<void> {\n    const renderOptions = Object.assign(buildRenderOptions(this.options, options), {\n      redirect: 'always'\n    });\n    return this.renderEl(renderOptions).then(() => {\n      // This method should never return, it will either redirect or reject with error\n      return;\n    });\n  }\n\n  /**\n   * Renders the widget. Either resolves the returned promise, or redirects.\n   * @param options - options for the signin widget\n   */\n  showSignIn(options?: RenderOptions): Promise<RenderResult> {\n    const renderOptions = Object.assign(buildRenderOptions(this.options, options));\n    return this.renderEl(renderOptions);\n  }\n\n  // Hook convenience functions\n  before(formName: string, callbackFn: HookFunction): void {\n    this.hooks.mergeHook(formName, {\n      before: [\n        callbackFn\n      ]\n    });\n  }\n\n  after(formName: string, callbackFn: HookFunction): void {\n    this.hooks.mergeHook(formName, {\n      after: [\n        callbackFn\n      ]\n    });\n  }\n\n  getUser(): any {\n    return this.router?.appState?.getUser();\n  }\n  \n  // Events API\n\n  on(event: EventName, callback: EventCallback | EventCallbackWithError): void {\n    // custom events listener on widget instance to trap third-party callback errors\n    if (EVENTS_LIST.includes(event)) {\n      const origCallback = callback;\n      callback = function(...callbackArgs) {\n        try {\n          origCallback.apply(this, callbackArgs);\n        } catch (err) {\n          Logger.error(`[okta-signin-widget] \"${event}\" event handler error:`, err);\n        }\n      };\n    }\n    this.Router.prototype.Events.on.call(this, event, callback);\n  }\n\n  off(event?: EventName, callback?: EventCallback | EventCallbackWithError): void {\n    this.Router.prototype.Events.off.call(this, event, callback);\n  }\n\n  once(event: EventName, callback: EventCallback): void {\n    this.Router.prototype.Events.once.call(this, event, callback);\n  }\n\n  stopListening(event?: EventName, callback?: EventCallback): void {\n    this.Router.prototype.Events.stopListening.call(this, event, callback);\n  }\n\n  listenTo(object: any, event: EventName, callback: EventCallback): void {\n    this.Router.prototype.Events.listenTo.call(this, object, event, callback);\n  }\n\n  trigger(event: EventName, ...args: any[]): void {\n    this.Router.prototype.Events.trigger.apply(this, [event, ...args]);\n  }\n\n}\n"],"names":["EVENTS_LIST","OktaSignIn","constructor","options","Router","hooks","router","authClient","Util","debugMessage","getAuthClient","useInteractionCodeFlow","isPKCE","Errors","ConfigError","Hooks","stateToken","isV1StateToken","proxyIdxResponse","V2Router","V1Router","prototype","Events","listenTo","call","trigger","once","context","renderEl","renderOptions","successFn","errorFn","Error","res","createRouter","promise","hide","show","remove","undefined","showSignInToGetTokens","Object","assign","buildRenderOptions","redirect","then","tokens","settings","isAuthorizationCodeFlow","showSignInAndRedirect","showSignIn","before","formName","callbackFn","mergeHook","after","getUser","appState","on","event","callback","includes","origCallback","callbackArgs","apply","err","Logger","error","off","stopListening","object","args"],"mappings":"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"}